import React, { useState, useEffect } from 'react';
import { supabase } from '../supabaseClient';
import { 
Â  Save, Edit3, Loader2, BookOpen, Clock, Download, 
Â  FileText, Zap, Database, ExternalLink, X, Maximize2 
} from 'lucide-react';
import { jsPDF } from "jspdf";

export default function SubjectNotes({ user }) {
Â  // --- 1. CONFIGURATION ---
Â  const coreSubjects = [
Â  Â  "Computer Science", "Reasoning", "Aptitude", 
Â  Â  "General Awareness", "Maths", "Physics", 
Â  Â  "Chemistry", "English"
Â  ];
Â  
Â  const [selectedSubject, setSelectedSubject] = useState(coreSubjects[0]);
Â  const [personalNote, setPersonalNote] = useState('');
Â  const [isSaving, setIsSaving] = useState(false);
Â  const [lastSaved, setLastSaved] = useState(null);
Â  const [libraryResources, setLibraryResources] = useState([]); 
Â  const [allNotes, setAllNotes] = useState([]); 
Â  const [loading, setLoading] = useState(true);

Â  // ðŸ”¥ NEW STATE: Controls the Main View (Editor vs PDF)
Â  const [activePdf, setActivePdf] = useState(null);

Â  // --- 2. DATA SYNCHRONIZATION ---
Â  useEffect(() => {
Â  Â  fetchLibraryAndHistory();
Â  }, [user.id]);

Â  useEffect(() => {
Â  Â  fetchNoteForSubject(selectedSubject);
Â  Â  setActivePdf(null); // Reset view to notes when changing subjects
Â  }, [selectedSubject, user.id]);

Â  const fetchLibraryAndHistory = async () => {
Â  Â  setLoading(true);
Â  Â  const { data: notes } = await supabase
Â  Â  Â  .from('subject_notes')
Â  Â  Â  .select('id, subject, updated_at')
Â  Â  Â  .eq('user_id', user.id)
Â  Â  Â  .order('updated_at', { ascending: false });
Â  Â  Â  
Â  Â  const { data: pdfs } = await supabase
Â  Â  Â  .from('study_materials')
Â  Â  Â  .select('*')
Â  Â  Â  .order('created_at', { ascending: false });

Â  Â  if (notes) setAllNotes(notes);
Â  Â  if (pdfs) setLibraryResources(pdfs);
Â  Â  setLoading(false);
Â  };

Â  const fetchNoteForSubject = async (subject) => {
Â  Â  setPersonalNote('');
Â  Â  setLastSaved(null);
Â  Â  const { data } = await supabase
Â  Â  Â  .from('subject_notes')
Â  Â  Â  .select('content, updated_at')
Â  Â  Â  .eq('user_id', user.id)
Â  Â  Â  .eq('subject', subject)
Â  Â  Â  .maybeSingle(); 
Â  Â  
Â  Â  if (data) {
Â  Â  Â  setPersonalNote(data.content);
Â  Â  Â  setLastSaved(new Date(data.updated_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
Â  Â  }
Â  };

Â  // --- 3. ACTIONS ---
Â  const handleSaveNote = async () => {
Â  Â  if (!personalNote.trim()) return;
Â  Â  setIsSaving(true);
Â  Â  const { error } = await supabase
Â  Â  Â  .from('subject_notes')
Â  Â  Â  .upsert({ 
Â  Â  Â  Â  user_id: user.id, 
Â  Â  Â  Â  subject: selectedSubject, 
Â  Â  Â  Â  content: personalNote,
Â  Â  Â  Â  updated_at: new Date()
Â  Â  Â  }, { onConflict: 'user_id,subject' });
Â  Â  
Â  Â  if (!error) {
Â  Â  Â  Â  const now = new Date();
Â  Â  Â  Â  setLastSaved(now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
Â  Â  Â  Â  fetchLibraryAndHistory();
Â  Â  }
Â  Â  setTimeout(() => setIsSaving(false), 500);
Â  };

Â  const downloadAsPDF = () => {
Â  Â  if (!personalNote) return;
Â  Â  const doc = new jsPDF();
Â  Â  doc.setFont("helvetica", "bold");
Â  Â  doc.setTextColor(37, 99, 235);
Â  Â  doc.setFontSize(22);
Â  Â  doc.text(`${selectedSubject} // Neural Transcript`, 20, 20);
Â  Â  doc.setFontSize(10);
Â  Â  doc.setFont("helvetica", "normal");
Â  Â  doc.setTextColor(150);
Â  Â  doc.text(`Generated by The Brain Portal | ${new Date().toLocaleString()}`, 20, 30);
Â  Â  doc.line(20, 35, 190, 35);
Â  Â  doc.setFontSize(12);
Â  Â  doc.setTextColor(0);
Â  Â  const splitText = doc.splitTextToSize(personalNote, 170);
Â  Â  doc.text(splitText, 20, 45);
Â  Â  doc.save(`${selectedSubject}_Notes.pdf`);
Â  };

Â  const relevantPDFs = libraryResources.filter(res => 
Â  Â  res.subject === selectedSubject || res.subject === 'General'
Â  );

Â  return (
Â  Â  <div className="space-y-8 pb-20 animate-in fade-in duration-500">
Â  Â  Â  
Â  Â  Â  {/* 1. SUBJECT NAVIGATION */}
Â  Â  Â  <div className="flex gap-3 overflow-x-auto pb-2 custom-scrollbar p-1">
Â  Â  Â  Â  {coreSubjects.map((sub) => (
Â  Â  Â  Â  Â  <button 
Â  Â  Â  Â  Â  Â  key={sub}
Â  Â  Â  Â  Â  Â  onClick={() => setSelectedSubject(sub)}
Â  Â  Â  Â  Â  Â  className={`px-6 py-3 rounded-2xl font-black transition-all text-[10px] uppercase tracking-widest whitespace-nowrap ${
Â  Â  Â  Â  Â  Â  Â  selectedSubject === sub 
Â  Â  Â  Â  Â  Â  Â  ? 'bg-blue-600 text-white shadow-lg shadow-blue-500/30 scale-105' 
Â  Â  Â  Â  Â  Â  Â  : 'bg-white dark:bg-gray-800 text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700'
Â  Â  Â  Â  Â  Â  }`}
Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  {sub}
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  ))}
Â  Â  Â  </div>

Â  Â  Â  <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
Â  Â  Â  Â  
Â  Â  Â  Â  {/* 2. DYNAMIC WORKSPACE (EDITOR OR PDF VIEWER) */}
Â  Â  Â  Â  <div className="lg:col-span-2 space-y-6">
Â  Â  Â  Â  Â  <div className="bg-white dark:bg-gray-800 p-8 rounded-[2.5rem] shadow-xl border dark:border-gray-700 relative overflow-hidden h-[650px] flex flex-col">
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  {/* Header Area */}
Â  Â  Â  Â  Â  Â  <div className="flex justify-between items-center mb-6 relative z-10">
Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  <h3 className="text-3xl font-black text-gray-800 dark:text-white uppercase tracking-tighter flex items-center gap-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  {activePdf ? (
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <FileText className="text-orange-500" /> 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span className="truncate max-w-[300px]">{activePdf.title}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </>
Â  Â  Â  Â  Â  Â  Â  Â  Â  ) : (
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {selectedSubject} <span className="text-gray-300 text-lg">/ NOTES</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </>
Â  Â  Â  Â  Â  Â  Â  Â  Â  )}
Â  Â  Â  Â  Â  Â  Â  Â  </h3>
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  {!activePdf && (
Â  Â  Â  Â  Â  Â  Â  Â  Â  <div className="flex items-center gap-2 mt-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {lastSaved ? (
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span className="text-[10px] text-green-500 font-bold uppercase tracking-widest flex items-center gap-1"><Zap size={10} /> Synced {lastSaved}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ) : (
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span className="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Unsaved Changes</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  )}
Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  )}
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  <div className="flex gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  {activePdf ? (
Â  Â  Â  Â  Â  Â  Â  Â  Â  <button 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onClick={() => setActivePdf(null)} 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  className="flex items-center gap-2 bg-red-100 text-red-600 px-6 py-3 rounded-xl font-black uppercase text-xs hover:bg-red-200 transition-all"
Â  Â  Â  Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <X size={16} /> Close PDF
Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  ) : (
Â  Â  Â  Â  Â  Â  Â  Â  Â  <>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onClick={downloadAsPDF} className="p-3 bg-gray-100 dark:bg-gray-700 rounded-xl text-gray-500 hover:text-blue-600 transition-colors">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <Download size={20} />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onClick={handleSaveNote}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  disabled={isSaving}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  className="flex items-center gap-2 bg-blue-600 text-white px-6 py-3 rounded-xl font-black uppercase text-xs tracking-widest hover:bg-blue-700 shadow-lg active:scale-95 disabled:opacity-50 transition-all"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {isSaving ? <Loader2 className="animate-spin" size={16} /> : <Save size={16} />}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {isSaving ? 'Syncing...' : 'Save Node'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  </>
Â  Â  Â  Â  Â  Â  Â  Â  )}
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  {/* ðŸ”¥ CONTENT AREA SWAPPER */}
Â  Â  Â  Â  Â  Â  <div className="flex-1 relative bg-gray-50 dark:bg-gray-900 rounded-[2rem] overflow-hidden border-2 border-gray-100 dark:border-gray-700">
Â  Â  Â  Â  Â  Â  Â  {activePdf ? (
Â  Â  Â  Â  Â  Â  Â  Â  // --- PDF VIEWER (IFRAME) ---
Â  Â  Â  Â  Â  Â  Â  Â  <iframe 
Â  Â  Â  Â  Â  Â  Â  Â  Â  // Google Docs Viewer allows embedding ANY public PDF url without CORS issues
Â  Â  Â  Â  Â  Â  Â  Â  Â  src={`https://docs.google.com/gview?url=${activePdf.url}&embedded=true`}
Â  Â  Â  Â  Â  Â  Â  Â  Â  className="w-full h-full"
Â  Â  Â  Â  Â  Â  Â  Â  Â  frameBorder="0"
Â  Â  Â  Â  Â  Â  Â  Â  Â  title="PDF Viewer"
Â  Â  Â  Â  Â  Â  Â  Â  />
Â  Â  Â  Â  Â  Â  Â  ) : (
Â  Â  Â  Â  Â  Â  Â  Â  // --- NOTE EDITOR ---
Â  Â  Â  Â  Â  Â  Â  Â  <>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <div className="absolute top-0 right-0 p-10 opacity-5 pointer-events-none"><Edit3 size={120} /></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  className="w-full h-full p-6 bg-transparent border-none focus:ring-0 text-lg font-medium leading-loose outline-none resize-none custom-scrollbar dark:text-white"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  placeholder={`Initialize neural stream for ${selectedSubject}...`}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  value={personalNote}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onChange={(e) => setPersonalNote(e.target.value)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  />
Â  Â  Â  Â  Â  Â  Â  Â  </>
Â  Â  Â  Â  Â  Â  Â  )}
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  {/* 3. SIDEBAR */}
Â  Â  Â  Â  <div className="space-y-6">
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  {/* A. LIBRARY RESOURCES (Click to View) */}
Â  Â  Â  Â  Â  <div className="bg-white dark:bg-gray-800 p-6 rounded-[2.5rem] shadow-xl border dark:border-gray-700">
Â  Â  Â  Â  Â  Â  <div className="flex items-center gap-3 mb-6 pb-4 border-b dark:border-gray-700">
Â  Â  Â  Â  Â  Â  Â  <Database size={20} className="text-orange-500" />
Â  Â  Â  Â  Â  Â  Â  <h4 className="font-black uppercase text-sm dark:text-white tracking-wide">Library Nodes</h4>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  {relevantPDFs.length > 0 ? (
Â  Â  Â  Â  Â  Â  Â  <div className="space-y-3 max-h-[300px] overflow-y-auto custom-scrollbar pr-2">
Â  Â  Â  Â  Â  Â  Â  Â  {relevantPDFs.map((res) => (
Â  Â  Â  Â  Â  Â  Â  Â  Â  <button 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  key={res.id} 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onClick={() => setActivePdf(res)} // ðŸ”¥ Set Active PDF
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  className={`w-full text-left p-4 rounded-2xl border transition-all group relative overflow-hidden ${
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  activePdf?.id === res.id 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ? 'bg-orange-500 text-white border-orange-600 shadow-lg' 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  : 'bg-gray-50 dark:bg-gray-900/50 hover:bg-orange-50 border-transparent hover:border-orange-200'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }`}
Â  Â  Â  Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div className="flex justify-between items-start relative z-10">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div className="flex-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h5 className={`font-bold text-xs line-clamp-2 leading-tight ${activePdf?.id === res.id ? 'text-white' : 'dark:text-white group-hover:text-orange-600'}`}>{res.title}</h5>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p className={`text-[8px] font-black uppercase mt-2 flex items-center gap-1 ${activePdf?.id === res.id ? 'text-white/80' : 'text-gray-400'}`}>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <FileText size={8} /> PDF Resource
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {activePdf?.id === res.id ? <Maximize2 size={12} className="text-white animate-pulse" /> : <ExternalLink size={12} className="text-gray-300 group-hover:text-orange-500" />}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  ))}
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  ) : (
Â  Â  Â  Â  Â  Â  Â  <div className="text-center py-10 opacity-50">
Â  Â  Â  Â  Â  Â  Â  Â  <BookOpen size={32} className="mx-auto text-gray-300 mb-2" />
Â  Â  Â  Â  Â  Â  Â  Â  <p className="text-[10px] font-black uppercase text-gray-400">No PDFs Indexed</p>
Â  Â  Â  Â  Â  Â  Â  Â  <p className="text-[8px] text-gray-300 mt-1">Check other nodes</p>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  )}
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  {/* B. RECENT EDITS */}
Â  Â  Â  Â  Â  <div className="bg-white dark:bg-gray-800 p-6 rounded-[2.5rem] shadow-xl border dark:border-gray-700">
Â  Â  Â  Â  Â  Â  <div className="flex items-center gap-3 mb-6 pb-4 border-b dark:border-gray-700">
Â  Â  Â  Â  Â  Â  Â  <Clock size={20} className="text-blue-600" />
Â  Â  Â  Â  Â  Â  Â  <h4 className="font-black uppercase text-sm dark:text-white tracking-wide">Recent Edits</h4>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  <div className="space-y-3 max-h-[250px] overflow-y-auto custom-scrollbar pr-2">
Â  Â  Â  Â  Â  Â  Â  {allNotes.map((note) => (
Â  Â  Â  Â  Â  Â  Â  Â  <button 
Â  Â  Â  Â  Â  Â  Â  Â  Â  key={note.id} 
Â  Â  Â  Â  Â  Â  Â  Â  Â  onClick={() => { setSelectedSubject(note.subject); setActivePdf(null); }}
Â  Â  Â  Â  Â  Â  Â  Â  Â  className="w-full group flex items-center justify-between p-3 rounded-xl hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-all text-left"
Â  Â  Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Â  Â  <div className="flex items-center gap-3 overflow-hidden">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div className={`w-1.5 h-8 rounded-full ${note.subject === selectedSubject ? 'bg-blue-600' : 'bg-gray-200'}`}></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p className="font-bold text-[10px] dark:text-white uppercase truncate w-32">{note.subject}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p className="text-[8px] text-gray-400 font-bold">{new Date(note.updated_at).toLocaleDateString()}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  ))}
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  );
}